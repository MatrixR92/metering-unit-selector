<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Metering Unit Selector</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
/* -----------------------------------
   Reset e impostazioni generali
----------------------------------- */
* {
  box-sizing: border-box;
}

html {
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}

body, h1, h2, h3, p, li, span {
  -webkit-font-smoothing: antialiased;
}

html, body {
  height: 100%;
  width: 100%;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
  font-family: "Myriad Pro", sans-serif;
  background-color: #2c2c2c;
  color: #f1f1f1;
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* -----------------------------------
   Header
----------------------------------- */
header {
  text-align: center;
  padding: 15px 20px 20px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background-color: rgba(44,44,44,0.8);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(20px);
}

header img.logo {
  max-width: 70px;
  margin: -3px auto 20px auto;
  display: block;
}

h1 {
  font-size: 22px;
  font-weight: bold;
  line-height: 1.2;
  margin: 0 0;
  text-align: center;
}

h2 {
  font-size: 18px;
  line-height: 1.3;
}

/* -----------------------------------
   Icone pulsanti Header
----------------------------------- */
.home-icon, .lang-icon {
  position: absolute;
  top: 18px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.home-icon { right: 18px; }
.lang-icon { left: 18px; }

.home-icon img, .lang-icon img {
  width: 100%;
  height: auto;
}

.lang-menu {
  position: absolute;
  top: 60px;
  left: 18px;
  background: #3a3a3a;
  border-radius: 12px;
  overflow: hidden;
  display: none;
  flex-direction: column;
  min-width: 120px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.lang-menu div {
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.lang-menu div:hover {
  background: #4a4a4a;
}

.lang-menu img {
  width: 24px;
  height: auto;
}

/* -----------------------------------
   Layout contenuto
----------------------------------- */
.content {
  padding-top: 130px; /* spazio per header */
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

.step { display: none; width: 100%; max-width: 900px; padding: 0 20px 20px; }
.step.active { display: block; }

/* -----------------------------------
   Grid
----------------------------------- */
.grid { display: grid; gap: 15px; }

.machines {
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
}

.machines .card img { max-width: 150px; margin-bottom: 0; }

.seeds {
  grid-template-columns: repeat(auto-fill, 110px);
  justify-content: center;
  gap: 10px;
}

.seeds .card {
  width: 110px;
  height: 110px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px;
}

.seeds .card img { max-width: 50px; margin-bottom: 15px; }

.seeds .card p {
  font-size: 15px;
  margin: 0;
  text-align: center;
  word-break: break-word;
  line-height: 1.4;
}

/* -----------------------------------
   Card generiche
----------------------------------- */
.card {
  background: #3a3a3a;
  border-radius: 12px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
}

.card:hover { background: #4a4a4a; }
.card.selected { border: 2px solid #FCC133; }

/* -----------------------------------
   Pulsanti
----------------------------------- */
.buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
  gap: 10px;
}

.buttons.center {
  flex-direction: column;
  align-items: center;
}

.buttons.sticky {
  position: sticky;
  bottom: 0;
  background: #2c2c2c;
  padding: 10px 0 26px;
  display: flex;
  justify-content: space-between;
  gap: 10px;
  z-index: 50;
}

.buttons.sticky button { flex: 1; }

.home-buttons {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 18px;
}

.home-buttons button {
  background: #FCC133;
  color: #000;
  border: none;
  padding: 18px;
  border-radius: 12px;
  font-size: 1.1rem;
  cursor: pointer;
  height: 200px;
  width: 100%;
  max-width: 420px;
}

.home-buttons button:hover { background: #e0a800; }

button {
  all: unset;
  display: inline-block;
  background: #FCC133;
  color: #000;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 1.1rem;
  cursor: pointer;
  text-align: center;
}

button:disabled { opacity: 0.5; cursor: not-allowed; }
button:hover:enabled { background: #e0a800; }

/* -----------------------------------
   Rocchetto
----------------------------------- */
.rocchetto {
  display: flex;
  align-items: center;
  background: #3a3a3a;
  border-radius: 12px;
  padding: 15px;
}

.rocchetto img { width: 120px; height: auto; }

.rocchetto-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.volume-box {
  display: inline-block;
  background: #fff;
  color: #2c2c2c;
  padding: 8px 15px;
  border-radius: 10px;
}

.volume-value { font-size: 2rem; font-weight: bold; }
.volume-unit { font-size: 1.4rem; margin-left: 4px; }
.code { font-size: 1.2rem; color: #fff; }

.rocchetto-card img { max-width: 120px; margin-bottom: 10px; }
.rocchetto-card p { font-size: 1.2rem; font-weight: bold; margin: 0; }

/* -----------------------------------
   Result Grid
----------------------------------- */
#result {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  width: 100%;
}

#result .rocchetto {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  background: #3a3a3a;
  border-radius: 12px;
  text-align: center;
}

#result .rocchetto img { height: auto; margin-bottom: 15px; }

#result .rocchetto .rocchetto-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 18px;
}

/* -----------------------------------
   Input
----------------------------------- */
input[type="text"] {
  background: #ffffff10;
  color: #fff;
  border: none;
  outline: none;
}

  </style>
</head>
<body>

  <header>
    <img src="img/logo.svg" alt="Logo" class="logo">
    <h1>METERING UNIT SELECTOR</h1>
<div class="lang-icon" title="Cambia lingua" onclick="toggleLangMenu()">
  <img src="img/it.png" alt="Lingua" id="currentLang">
</div>
<div class="lang-menu" id="langMenu">
  <div onclick="setLang('it')"><img src="img/it.png" alt="Italiano"> Italiano</div>
  <div onclick="setLang('en')"><img src="img/en.png" alt="English"> English</div>
  <div onclick="setLang('fr')"><img src="img/fr.png" alt="Français"> Français</div>
</div>	
	<div class="home-icon" title="Home" onclick="goHome()" style="display:none">
		<img src="img/home.svg" alt="Home">
	</div>
	
  </header>

<main class="content">
  <!-- HOME -->
  <div class="step active" id="home">

    <h2 data-i18n="homeTitle" style="text-align:center;">Benvenuto nel Metering Unit Selector</h2>

    <div class="home-buttons" style="display:flex;align-items:center;justify-content:center;">
      <button onclick="nextStep('step1')">
        <div style="display:flex;flex-direction:column;align-items:center;">
          <img src="img/trova_rocchetto.svg" alt="" style="height:100px;margin-bottom:20px">
          <span data-i18n="trovaRocchetto">Trova Rocchetto</span>
        </div>
      </button>

      <button onclick="nextStep('stepCodice')">
        <div style="display:flex;flex-direction:column;align-items:center;">
          <img src="img/cerca_codice.svg" alt="" style="height:110px;margin-bottom:20px">
          <span data-i18n="cercaCodice">Cerca per Codice</span>
        </div>
      </button>
    </div>
  </div>

  <!-- STEP Codice (lista rocchetti) -->
  <div class="step" id="stepCodice">
    
	<h2 data-i18n="cercaCodice" style="text-align:center;">Cerca per Codice Rocchetto</h2>
    
	<input type="text" id="searchRocchetto" placeholder="Cerca codice..." onkeyup="filterRocchetto()" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:15px;font-size:14px;">
    <div class="grid rocchetti seeds" id="rocchettoGrid"></div>

  </div>

  <!-- STEP Macchina -->
  <div class="step" id="step1">
  
    <h2 data-i18n="stepMacchina" style="text-align:center;">Seleziona la tua Macchina</h2>
	
    <div class="grid machines" id="machinesGrid">
      <div class="card" onclick="selectItem('machine','m1', this)"><img src="img/JETM_RMT_1.png" alt="JET-M"><p>JET-M</p></div>
      <div class="card" onclick="selectItem('machine','m2', this)"><img src="img/JETX_RTEK_1.png" alt="JET-X"><p>JET-X</p></div>
      <div class="card" onclick="selectItem('machine','m3', this)"><img src="img/PRO1.png" alt="ASPRO"><p>ASPRO</p></div>
      <div class="card" onclick="selectItem('machine','m4', this)"><img src="img/ASMAX_V2_1.png" alt="ASMAX"><p>ASMAX</p></div>
      <div class="card" onclick="selectItem('machine','m5', this)"><img src="img/AB3_2400_H1.800.png" alt="AIRBOOST"><p>AIRBOOST</p></div>
    </div>

    <div class="buttons sticky" >

      <button data-i18n="btnAvanti" onclick="nextStep('step2')" id="btnStep1" disabled>Avanti</button>
    </div>
  </div>

  <!-- STEP Seme -->
  <div class="step" id="step2">
    
	<h2 data-i18n="stepSeme" style="text-align:center;">Seleziona il Seme</h2>
	
    <input type="text" id="searchSeed" placeholder="Cerca seme..." onkeyup="filterSeeds()" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:15px;font-size:14px;">
    <div class="grid seeds" id="seedGrid">
      <div class="card" data-seed="avena" onclick="selectItem('seed','avena', this)"><img src="img/avena.svg" alt="Avena"><p>Avena</p></div>
      <div class="card" data-seed="colza" onclick="selectItem('seed','colza', this)"><img src="img/colza.svg" alt="Colza"><p>Colza</p></div>
      <div class="card" data-seed="cumino" onclick="selectItem('seed','cumino', this)"><img src="img/cumino.svg" alt="Cumino"><p>Cumino</p></div>
      <div class="card" data-seed="erba_medica" onclick="selectItem('seed','erba_medica', this)"><img src="img/erba_medica.svg" alt="Erba medica"><p>Erba medica</p></div>
      <div class="card" data-seed="fagioli" onclick="selectItem('seed','fagioli', this)"><img src="img/fagioli.svg" alt="Fagioli"><p>Fagioli</p></div>
      <div class="card" data-seed="farro" onclick="selectItem('seed','farro', this)"><img src="img/farro.svg" alt="Farro"><p>Farro</p></div>
      <div class="card" data-seed="favino" onclick="selectItem('seed','favino', this)"><img src="img/favino.svg" alt="Favino"><p>Favino</p></div>
      <div class="card" data-seed="frumento" onclick="selectItem('seed','frumento', this)"><img src="img/frumento.svg" alt="Frumento"><p>Frumento</p></div>
      <div class="card" data-seed="grano_saraceno" onclick="selectItem('seed','grano_saraceno', this)"><img src="img/grano_saraceno.svg" alt="Grano saraceno"><p>Grano saraceno</p></div>
      <div class="card" data-seed="lino" onclick="selectItem('seed','lino', this)"><img src="img/lino.svg" alt="Lino"><p>Lino</p></div>
      <div class="card" data-seed="loietto" onclick="selectItem('seed','loietto', this)"><img src="img/loietto.svg" alt="Loietto"><p>Loietto</p></div>
      <div class="card" data-seed="lupini" onclick="selectItem('seed','lupini', this)"><img src="img/lupini.svg" alt="Lupini"><p>Lupini</p></div>
      <div class="card" data-seed="miglio" onclick="selectItem('seed','miglio', this)"><img src="img/miglio.svg" alt="Miglio"><p>Miglio</p></div>
      <div class="card" data-seed="orzo" onclick="selectItem('seed','orzo', this)"><img src="img/orzo.svg" alt="Orzo"><p>Orzo</p></div>
      <div class="card" data-seed="papavero" onclick="selectItem('seed','papavero', this)"><img src="img/papavero.svg" alt="Papavero"><p>Papavero</p></div>
      <div class="card" data-seed="phacelia" onclick="selectItem('seed','phacelia', this)"><img src="img/phacelia.svg" alt="Phacelia"><p>Phacelia</p></div>
      <div class="card" data-seed="piselli" onclick="selectItem('seed','piselli', this)"><img src="img/piselli.svg" alt="Piselli"><p>Piselli</p></div>
      <div class="card" data-seed="rape" onclick="selectItem('seed','rape', this)"><img src="img/rape.svg" alt="Rape"><p>Rape</p></div>
      <div class="card" data-seed="ravanello_foraggio" onclick="selectItem('seed','ravanello_foraggio', this)"><img src="img/ravanello_foraggio.svg" alt="Ravanello del foraggio"><p>Ravanello del foraggio</p></div>
      <div class="card" data-seed="riso" onclick="selectItem('seed','riso', this)"><img src="img/riso.svg" alt="Riso"><p>Riso</p></div>
      <div class="card" data-seed="segale" onclick="selectItem('seed','segale', this)"><img src="img/segale.svg" alt="Segale"><p>Segale</p></div>
      <div class="card" data-seed="semi_erba" onclick="selectItem('seed','semi_erba', this)"><img src="img/semi_erba.svg" alt="Semi di Erba"><p>Semi di Erba</p></div>
      <div class="card" data-seed="senape" onclick="selectItem('seed','senape', this)"><img src="img/senape.svg" alt="Senape"><p>Senape</p></div>
      <div class="card" data-seed="soia" onclick="selectItem('seed','soia', this)"><img src="img/soia.svg" alt="Soia"><p>Soia</p></div>
      <div class="card" data-seed="trifoglio_rosso" onclick="selectItem('seed','trifoglio_rosso', this)"><img src="img/trifoglio_rosso.svg" alt="Trifoglio Rosso"><p>Trifoglio Rosso</p></div>
      <div class="card" data-seed="vecce" onclick="selectItem('seed','vecce', this)"><img src="img/vecce.svg" alt="Vecce"><p>Vecce</p></div>
    </div>

    <div class="buttons sticky">
      <button data-i18n="btnIndietro" onclick="prevStep('step1')">Indietro</button>
      <button data-i18n="trovaRocchetto" onclick="nextStep('step3')" id="btnStep2" disabled>Trova Rocchetto</button>
    </div>
  </div>

  <!-- STEP Risultato -->
  <div class="step" id="step3">
  
    <h2 data-i18n="stepRocchetti" style="text-align:center;">Rocchetti Consigliati</h2>
	
    <div class="result" id="result"></div>
    <div class="buttons sticky">
      <button data-i18n="btnIndietro" onclick="prevStep('step2')">Indietro</button>
      <button data-i18n="btnNuovaRicerca" onclick="restart()">Nuova Ricerca</button>
    </div>
  </div>

  <!-- STEP Seeds per rocchetto (dalla ricerca per codice) -->
  <div class="step" id="stepSeeds">
  
    <h2 data-i18n="stepSemiCompatibili" style="text-align:center;">Semi compatibili</h2>
	
    <div class="grid seeds" id="seedsByRocchetto"></div>
    <div class="buttons sticky">
      <button data-i18n="btnIndietro" onclick="prevStep('stepCodice')">Indietro</button>
    </div>
  </div>

</main>

<script>
/* --- variabili di stato --- */
let selectedMachine = null;
let selectedSeed = null;
let seedsForSelectedRocchetto = []; // memorizza semi compatibili dell'ultimo rocchetto selezionato
let currentLang = 'it'; // default

// --------------------------
// 1. Traduzioni multilingua
// --------------------------
const translations = {
  it: {
    homeTitle: "Benvenuto nel Metering Unit Selector",
    trovaRocchetto: "Trova Rocchetto",
    cercaCodice: "Cerca per Codice",
    stepMacchina: "Seleziona la tua Macchina",
    stepSeme: "Seleziona il Seme",
    stepRocchetti: "Rocchetti Consigliati",
    stepSemiCompatibili: "Semi compatibili",
    btnAvanti: "Avanti",
    btnIndietro: "Indietro",
    btnNuovaRicerca: "Nuova Ricerca",
    placeholderCodice: "Cerca codice...",
    placeholderSeme: "Cerca seme...",
	
	seeds: {
      avena: "Avena",
      colza: "Colza",
      cumino: "Cumino",
      erba_medica: "Erba medica",
      fagioli: "Fagioli",
      farro: "Farro",
      favino: "Favino",
      frumento: "Frumento",
      grano_saraceno: "Grano saraceno",
      lino: "Lino",
      loietto: "Loietto",
      lupini: "Lupini",
      miglio: "Miglio",
      orzo: "Orzo",
      papavero: "Papavero",
      phacelia: "Phacelia",
      piselli: "Piselli",
      rape: "Rape",
      ravanello_foraggio: "Ravanello del foraggio",
      riso: "Riso",
      segale: "Segale",
      semi_erba: "Semi di Erba",
      senape: "Senape",
      soia: "Soia",
      trifoglio_rosso: "Trifoglio Rosso",
      vecce: "Vecce"
    }
  },
  en: {
    homeTitle: "Welcome to the Metering Unit Selector",
    trovaRocchetto: "Find Metering Unit",
    cercaCodice: "Search by Code",
    stepMacchina: "Select your Machine",
    stepSeme: "Select the Seed",
    stepRocchetti: "Recommended Metering Unit",
    stepSemiCompatibili: "Compatible Seeds",
    btnAvanti: "Next",
    btnIndietro: "Back",
    btnNuovaRicerca: "New Search",
    placeholderCodice: "Search code...",
    placeholderSeme: "Search seed...",
	
	seeds: {
      avena: "Oats",
      colza: "Rapeseed",
      cumino: "Caraway",
      erba_medica: "Alfalfa",
      fagioli: "Beans",
      farro: "Spelt",
      favino: "Field bean",
      frumento: "Wheat",
      grano_saraceno: "Buckwheat",
      lino: "Flax",
      loietto: "Ryegrass",
      lupini: "Lupins",
      miglio: "Millet",
      orzo: "Barley",
      papavero: "Poppy",
      phacelia: "Phacelia",
      piselli: "Peans",
      rape: "Turnips",
      ravanello_foraggio: "Fodder Radish",
      riso: "Rice",
      segale: "Rye",
      semi_erba: "Grass Seeds",
      senape: "Mustard",
      soia: "Soy",
      trifoglio_rosso: "Red Clover",
      vecce: "Vetches"
    }
  },
  fr: {
    homeTitle: "Bienvenue dans le Sélecteur de Bobines",
    trovaRocchetto: "Trouver Bobine",
    cercaCodice: "Chercher par Code",
    stepMacchina: "Sélectionnez votre Machine",
    stepSeme: "Sélectionnez la Graine",
    stepRocchetti: "Bobines Recommandées",
    stepSemiCompatibili: "Graines Compatibles",
    btnAvanti: "Suivant",
    btnIndietro: "Retour",
    btnNuovaRicerca: "Nouvelle Recherche",
    placeholderCodice: "Chercher le code...",
    placeholderSeme: "Chercher la graine...",
	
	seeds: {
      avena: "Avoine",
      colza: "Colza",
      cumino: "Cumin",
      erba_medica: "Luzerne",
      fagioli: "Haricots",
      farro: "Épeautre",
      favino: "Fèverole",
      frumento: "Blé",
      grano_saraceno: "Sarrasin",
      lino: "Lin",
      loietto: "Ray-grass",
      lupini: "Lupin",
      miglio: "Millet",
      orzo: "Orge",
      papavero: "Pavot",
      phacelia: "Phacélie",
      piselli: "Pois",
      rape: "Navet",
      ravanello_foraggio: "Radis Fourrager",
      riso: "Riz",
      segale: "Seigle",
      semi_erba: "Graminées",
      senape: "Moutarde",
      soia: "Soja",
      trifoglio_rosso: "Trèfle",
      vecce: "Vesces"
	}
  },
};


/* --- rocchetti (mappa) --- */
const rocchetti = {
  r1: { codice: "M79A00833", volume: 5.5, img: "img/m79a00833.svg" },
  r2: { codice: "M79A00651", volume: 11, img: "img/m79a00651.svg" },
  r3: { codice: "M79A00650", volume: 22, img: "img/m79a00650.svg" },
  r4: { codice: "M79A00552", volume: 55, img: "img/m79a00552.svg" },
  r5: { codice: "M79A00649", volume: 165, img: "img/m79a00649.svg" },
  r6: { codice: "M79A00550", volume: 196, img: "img/m79a00550.svg" },
  r7: { codice: "M79A00549", volume: 392, img: "img/m79a00549.svg" },
  r8: { codice: "M79A00548", volume: 588, img: "img/m79a00548.svg" }
};

/* --- mapping macchine -> semi -> array di id rocchetti --- */
const data = {
  m1: {
    avena: ["r4","r5"],
    colza: ["r1","r2"],
    cumino: ["r2","r3"],
    erba_medica: ["r2","r3","r4"],
    fagioli: ["r6","r7"],
    farro: ["r7","r8"],
    favino: ["r6","r7","r8"],
    frumento: ["r4","r5"],
    grano_saraceno: ["r5","r6"],
    lino: ["r4","r5"],
    loietto: ["r5","r6"],
    lupini: ["r5","r6"],
    miglio: ["r5"],
    orzo: ["r4","r5"],
    papavero: ["r1","r2"],
    phacelia: ["r2","r3"],
    piselli: ["r6","r7","r8"],
    rape: ["r2","r3"],
    ravanello_foraggio: ["r2","r3"],
    riso: ["r5","r6","r7"],
    segale: ["r5","r6","r7"],
    semi_erba: ["r5","r6","r7"],
    senape: ["r1","r2","r3"],
    soia: ["r6","r7"],
    trifoglio_rosso: ["r1","r2","r3"],
    vecce: ["r5","r6"]
  },
  m2: {
    avena: ["r4","r5"],
    colza: ["r1","r2"],
    cumino: ["r2","r3"],
    erba_medica: ["r2","r3","r4"],
    fagioli: ["r6","r7"],
    farro: ["r7","r8"],
    favino: ["r6","r7","r8"],
    frumento: ["r4","r5"],
    grano_saraceno: ["r5","r6"],
    lino: ["r4","r5"],
    loietto: ["r5","r6"],
    lupini: ["r5","r6"],
    miglio: ["r5"],
    orzo: ["r4","r5"],
    papavero: ["r1","r2"],
    phacelia: ["r2","r3"],
    piselli: ["r6","r7","r8"],
    rape: ["r2","r3"],
    ravanello_foraggio: ["r2","r3"],
    riso: ["r5","r6","r7"],
    segale: ["r5","r6","r7"],
    semi_erba: ["r5","r6","r7"],
    senape: ["r1","r2","r3"],
    soia: ["r6","r7"],
    trifoglio_rosso: ["r1","r2","r3"],
    vecce: ["r5","r6"]
  },
  m3: {
    avena: ["r4","r5"],
    colza: ["r1","r2"],
    cumino: ["r2","r3"],
    erba_medica: ["r2","r3","r4"],
    fagioli: ["r6","r7"],
    farro: ["r7","r8"],
    favino: ["r6","r7","r8"],
    frumento: ["r4","r5"],
    grano_saraceno: ["r5","r6"],
    lino: ["r4","r5"],
    loietto: ["r5","r6"],
    lupini: ["r5","r6"],
    miglio: ["r5"],
    orzo: ["r4","r5"],
    papavero: ["r1","r2"],
    phacelia: ["r2","r3"],
    piselli: ["r6","r7","r8"],
    rape: ["r2","r3"],
    ravanello_foraggio: ["r2","r3"],
    riso: ["r5","r6","r7"],
    segale: ["r5","r6","r7"],
    semi_erba: ["r5","r6","r7"],
    senape: ["r1","r2","r3"],
    soia: ["r6","r7"],
    trifoglio_rosso: ["r1","r2","r3"],
    vecce: ["r5","r6"]
  },
  m4: {
    avena: ["r4","r5"],
    colza: ["r1","r2"],
    cumino: ["r2","r3"],
    erba_medica: ["r2","r3","r4"],
    fagioli: ["r6","r7"],
    farro: ["r7","r8"],
    favino: ["r6","r7","r8"],
    frumento: ["r4","r5"],
    grano_saraceno: ["r5","r6"],
    lino: ["r4","r5"],
    loietto: ["r5","r6"],
    lupini: ["r5","r6"],
    miglio: ["r5"],
    orzo: ["r4","r5"],
    papavero: ["r1","r2"],
    phacelia: ["r2","r3"],
    piselli: ["r6","r7","r8"],
    rape: ["r2","r3"],
    ravanello_foraggio: ["r2","r3"],
    riso: ["r5","r6","r7"],
    segale: ["r5","r6","r7"],
    semi_erba: ["r5","r6","r7"],
    senape: ["r1","r2","r3"],
    soia: ["r6","r7"],
    trifoglio_rosso: ["r1","r2","r3"],
    vecce: ["r5","r6"]
  },
  m5: {
    avena: ["r4","r5"],
    colza: ["r1","r2"],
    cumino: ["r2","r3"],
    erba_medica: ["r2","r3","r4"],
    fagioli: ["r6","r7"],
    farro: ["r7","r8"],
    favino: ["r6","r7","r8"],
    frumento: ["r4","r5"],
    grano_saraceno: ["r5","r6"],
    lino: ["r4","r5"],
    loietto: ["r5","r6"],
    lupini: ["r5","r6"],
    miglio: ["r5"],
    orzo: ["r4","r5"],
    papavero: ["r1","r2"],
    phacelia: ["r2","r3"],
    piselli: ["r6","r7","r8"],
    rape: ["r2","r3"],
    ravanello_foraggio: ["r2","r3"],
    riso: ["r5","r6","r7"],
    segale: ["r5","r6","r7"],
    semi_erba: ["r5","r6","r7"],
    senape: ["r1","r2","r3"],
    soia: ["r6","r7"],
    trifoglio_rosso: ["r1","r2","r3"],
    vecce: ["r5","r6"]
  }
};

/* --- funzioni generiche --- */
function selectItem(type, id, element) {
  if(type==='machine') selectedMachine = id;
  if(type==='seed') selectedSeed = id;

  const container = type==='machine' ? document.querySelectorAll('#step1 .card') : document.querySelectorAll('#seedGrid .card');
  container.forEach(c=>c.classList.remove('selected'));
  element.classList.add('selected');

  if(type==='machine') document.getElementById('btnStep1').disabled = false;
  if(type==='seed') document.getElementById('btnStep2').disabled = false;
}

function nextStep(stepId){
  document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(stepId);
  if(!el) return;
  el.classList.add('active');
  setHomeIconVisibility(stepId);

  if(stepId==='stepCodice') loadRocchettoGrid();
  if(stepId==='step2') updateSeedGrid();
  if(stepId==='step3') showRocchetto();
  
  requestAnimationFrame(() => {
  window.scrollTo(0, 0);
  });
}

function prevStep(stepId){ nextStep(stepId); }

function goHome() {
  // --- Nasconde tutti gli step e mostra la home ---
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  const homeEl = document.getElementById('home');
  if (homeEl) homeEl.classList.add('active');
  setHomeIconVisibility('home');

  // --- Reset stato JS ---
  selectedMachine = null;
  selectedSeed = null;
  window._selectedSeedId = null;
  window.seedsFiltered = [];
  window.lastSeedQuery = '';

  // --- Rimuove classi residue che influenzano visualizzazione/selezione ---
  const residueClasses = ['selected', 'has-value', 'seed-selected', 'with-icon', 'show-seed'];
  residueClasses.forEach(cls => {
    document.querySelectorAll(`.${cls}`).forEach(el => el.classList.remove(cls));
  });

  // --- Rimuove selezioni residue dalle card specifiche ---
  document.querySelectorAll('#seedGrid .card.selected, #seedsByRocchetto .card.selected').forEach(card => {
    card.classList.remove('selected');
    card.removeAttribute('data-selected');
    card.removeAttribute('aria-selected');
  });

  // --- Nasconde eventuali preview di semi o icone residue ---
  const seedPreviews = document.querySelectorAll('.seed-icon-preview, .selected-seed, .seed-preview');
  seedPreviews.forEach(el => {
    if (el.tagName === 'IMG') el.src = '';
    el.style.display = 'none';
  });

  // --- Reset pulsanti ---
  const btnStep1 = document.getElementById('btnStep1');
  const btnStep2 = document.getElementById('btnStep2');
  if (btnStep1) btnStep1.disabled = true;
  if (btnStep2) btnStep2.disabled = true;

  // --- Reset input di ricerca ---
  const searchSeed = document.getElementById('searchSeed');
  const searchRocchetto = document.getElementById('searchRocchetto');

  [searchSeed, searchRocchetto].forEach(input => {
    if (!input) return;
    input.value = '';
    input.blur();
    // Triggera l'evento input e change per aggiornare la griglia
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
  });

  // --- Pulisce i container delle griglie ---
  const seedsContainer = document.getElementById('seedsByRocchetto');
  if (seedsContainer) seedsContainer.innerHTML = '';
  const rocchettoGrid = document.getElementById('rocchettoGrid');
  if (rocchettoGrid) rocchettoGrid.innerHTML = '';

  // --- Forza repaint e ricostruzione della griglia ---
  requestAnimationFrame(() => {
    if (typeof updateSeedGrid === 'function') updateSeedGrid(true);
    if (typeof loadRocchettoGrid === 'function') loadRocchettoGrid();
  });

  // --- Scrolla in cima ---
  window.scrollTo({ top: 0, behavior: 'smooth' });
}






/* mostra rocchetti consigliati */
function showRocchetto(){
  const result = document.getElementById('result');
  result.innerHTML = '';
  if(selectedMachine && selectedSeed && data[selectedMachine] && data[selectedMachine][selectedSeed]){
    const ids = data[selectedMachine][selectedSeed].slice().sort((a,b)=>rocchetti[a].volume-rocchetti[b].volume);
    ids.forEach(id=>{
      const r = rocchetti[id];
      result.innerHTML += `
        <div class="rocchetto">
          <img src="${r.img}" alt="Rocchetto">
          <div class="rocchetto-info">
            <div class="volume-box"><span class="volume-value">${r.volume}</span><span class="volume-unit">cm³</span></div>
            <div class="code">${r.codice}</div>
          </div>
        </div>`;
    });
  } else {
    result.innerHTML = `<p>${translations[currentLang].stepRocchetti}: Nessun rocchetto trovato</p>`;
  }
}

/* reset */
function restart(){
  selectedMachine = null;
  selectedSeed = null;
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('btnStep1').disabled = true;
  document.getElementById('btnStep2').disabled = true;
  document.getElementById('searchSeed').value='';
  updateSeedGrid();
  nextStep('home');
}

/* filtri */
function filterSeeds(){
  const input = document.getElementById('searchSeed').value.toLowerCase();
  document.querySelectorAll('#seedGrid .card').forEach(card=>{
    const name = card.querySelector('p').textContent.toLowerCase();
    card.style.display = name.includes(input) ? 'flex':'none';
  });
}

function filterRocchetto(){
  const input = document.getElementById('searchRocchetto').value.toLowerCase();
  document.querySelectorAll('#rocchettoGrid .card').forEach(card=>{
    const text = card.querySelector('p').textContent.toLowerCase();
    card.style.display = text.includes(input) ? 'flex':'none';
  });
}

/* gestione rocchetto selezionato */
function selectRocchetto(id){
  const semiSet = new Set();
  Object.values(data).forEach(machine=>{
    Object.entries(machine).forEach(([seed, arr])=>{
      if(arr.includes(id)) semiSet.add(seed);
    });
  });

  seedsForSelectedRocchetto = Array.from(semiSet).sort(); // <-- sostituisce seedsArray

  document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
  document.getElementById('stepSeeds').classList.add('active');
  setHomeIconVisibility('stepSeeds');

  renderSeedsByRocchetto(); // <-- genera la griglia
}

function renderSeedsByRocchetto(){
  const container = document.getElementById('seedsByRocchetto');
  if(!container) return;
  container.innerHTML = '';
  seedsForSelectedRocchetto.forEach(seed=>{
    const name = translations[currentLang].seeds[seed] || seed;
    container.innerHTML += `<div class="card"><img src="img/${seed}.svg" alt="${name}"><p>${name}</p></div>`;
  });
}

/* aggiorna il contenuto delle card semi automaticamente */
function updateSeedGrid(force = false) {
  if (!force && window.currentStep !== 'step2') return;

  const searchInput = document.getElementById('searchSeed');
  const filter = searchInput ? searchInput.value.trim().toLowerCase() : '';

  const seedGrid = document.getElementById('seedGrid');
  if (!seedGrid) return;

  // svuota la griglia prima di ricrearla
  seedGrid.innerHTML = '';

  // scorri tutti i semi definiti in translations
  const allSeeds = Object.keys(translations[currentLang].seeds || {});
  allSeeds.forEach(seedId => {
    const name = translations[currentLang].seeds[seedId];
    if (filter && !name.toLowerCase().includes(filter)) return; // filtra

    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.seed = seedId;
    card.setAttribute('onclick', `selectItem('seed','${seedId}',this)`);

    const img = document.createElement('img');
    img.src = `img/${seedId}.svg`; // modifica percorso immagini se necessario
    img.alt = name;

    const p = document.createElement('p');
    p.textContent = name;

    card.appendChild(img);
    card.appendChild(p);

    seedGrid.appendChild(card);
  });

  // aggiorna il placeholder
  if (searchInput && translations[currentLang] && translations[currentLang].placeholderSeme) {
    searchInput.placeholder = translations[currentLang].placeholderSeme;
  }
}


/* griglia rocchetti */
function loadRocchettoGrid(){
  const grid = document.getElementById('rocchettoGrid');
  grid.innerHTML = '';
  Object.entries(rocchetti).forEach(([id,r])=>{
    grid.innerHTML += `<div class="card" onclick="selectRocchetto('${id}')">
      <img src="${r.img}" alt="${r.codice}" style="width:80px;max-width:none;height:auto;">
      <p style="font-size:15px;margin-top:5px;">${r.codice}</p>
    </div>`;
  });
}

function setHomeIconVisibility(stepId){
  const homeIcon = document.querySelector('.home-icon');
  if(!homeIcon) return;
  homeIcon.style.display = stepId==='home' ? 'none' : 'flex';
}

/* lingua */
function toggleLangMenu(){
  const menu = document.getElementById('langMenu');
  menu.style.display = menu.style.display==='flex'?'none':'flex';
}

function setLang(lang){
  currentLang = lang;
  document.getElementById('currentLang').src = 'img/' + lang + '.png';
  document.getElementById('langMenu').style.display = 'none';
  
  // aggiorna titoli e semi
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const translation = translations[lang] && translations[lang][key];
    if (translation) {
      if (el.tagName.toLowerCase() === "input") {
        el.placeholder = translation; 
      } else {
        el.textContent = translation;
      }
    }
  });

  // FORZA l'aggiornamento della griglia dei semi anche se currentStep non è settato correttamente
  if (typeof updateSeedGrid === 'function') updateSeedGrid(true);

  // aggiorna anche la griglia semi compatibili (se esiste), forzando l'aggiornamento
  if (typeof renderSeedsByRocchetto === 'function') renderSeedsByRocchetto(true);
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('Service Worker registrato:', reg))
      .catch(err => console.error('Errore Service Worker:', err));
  });
}

document.addEventListener('click', (e) => {
  const langMenu = document.getElementById('langMenu');
  const langIcon = document.querySelector('.lang-icon');
  if (!langMenu.contains(e.target) && !langIcon.contains(e.target)) {
    langMenu.style.display = 'none';
  }
});

/* esporta funzioni globali */
window.selectItem = selectItem;
window.selectRocchetto = selectRocchetto;
window.nextStep = nextStep;
window.prevStep = prevStep;
window.goHome = goHome;
window.restart = restart;
window.toggleLangMenu = toggleLangMenu;
window.setLang = setLang;
window.addEventListener('DOMContentLoaded', updateSeedGrid);

</script>
</body>
</html>


